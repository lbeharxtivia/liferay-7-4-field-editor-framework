(()=>{const e=e=>{const t=document.querySelector("#portlet_com_liferay_journal_web_portlet_JournalPortlet, .page-editor__item-configuration-sidebar"),n=document.evaluate(`//label[text()='${e}']`,t,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return n?.closest(".form-group, .field-wrapper")?.querySelector("input")||n?.nextElementSibling?.querySelector("input")||n?.nextSibling},t=()=>document.querySelector("#portlet_com_liferay_journal_web_portlet_JournalPortlet, .page-editor__topper.active").querySelector(".page-editor__topper.active img.page-editor__editable, .image-picker-preview>img"),n=(e,t)=>{e.focus(),Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value").set.call(e,t),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),document.body.focus(),e.dispatchEvent(new Event("blur",{bubbles:!0}))},r=r=>{r.stopPropagation(),r.preventDefault();const o=t();o?.src?(()=>{const r=e("Focal Point X"),o=e("Focal Point Y"),a=t(),l=parseInt(r?.value)||50,i=parseInt(o?.value)||50,s=a?.src;let c=l,u=i;const d=(({imgSrc:e})=>{const t=document.createElement("dialog");return t.classList.add("focal-point-container"),t.style.cssText="\n    padding: 20px;\n    border-radius: 8px;\n    border: none;\n    box-shadow: 0 4px 20px rgba(0,0,0,0.5);\n    max-width: 95vw;\n    max-height: 95vh;\n    overflow: hidden;\n    ",t.innerHTML=`\n            <div style="\n    display:flex; \n    flex-direction:column; \n    gap:15px; \n    align-items:center;\n    ">\n                <h3>Set Focal Point</h3>\n                <div id="fp-container" style="\n    position:relative; \n    cursor:crosshair; \n    line-height:0;\n    ">\n                    <img src="${e}" style="\n    max-width:80vw; \n    max-height:70vh; \n    min-height:40vh; \n    display:block; \n    user-select:none;\n    " draggable="false">\n                    <div id="fp-marker" style="\n    position:absolute; \n    width:20px; \n    height:20px; \n    background:rgba(255, 62, 62, 0.8); \n    border:2px solid #fff; \n    border-radius:50%; \n    pointer-events:none; \n    transform:translate(-50%,-50%); \n    box-shadow:0 0 5px rgba(0,0,0,0.5);\n    "></div>\n                </div>\n                <div style="display:flex; gap:10px;">\n                    <button id="fp-save" class="btn btn-primary">Save Coordinates</button>\n                    <button id="fp-cancel" class="btn btn-secondary">Cancel</button>\n                </div>\n            </div>\n        `,document.body.appendChild(t),t})({imgSrc:s});d.showModal();const h=d.querySelector("#fp-container"),f=d.querySelector("img"),b=d.querySelector("#fp-marker"),m=(e,t)=>{b.style.left=`${e}%`,b.style.top=`${t}%`};m(c,u),h.addEventListener("click",e=>{const t=f.getBoundingClientRect();c=Math.round((e.clientX-t.left)/t.width*100),u=Math.round((e.clientY-t.top)/t.height*100),c=Math.max(0,Math.min(100,c)),u=Math.max(0,Math.min(100,u)),m(c,u)}),d.querySelector("#fp-save").onclick=async()=>{(async({pendingX:t,pendingY:r})=>{const o=e("Focal Point X"),a=e("Focal Point Y");o&&a?(n(o,t.toString()),setTimeout(()=>{o.focus(),o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0})),document.body.focus(),o.dispatchEvent(new Event("blur",{bubbles:!0}))},200),await new Promise(e=>setTimeout(()=>{n(a,r.toString()),e(!0)},100))):console.error("Could not find focal point input fields.")})({pendingX:c,pendingY:u}),(({previewImage:e})=>{e.style.outline="4px solid #4CAF50",setTimeout(()=>e.style.outline="none",1e3)})({previewImage:a}),d.close(),d.remove()},d.querySelector("#fp-cancel").onclick=()=>{d.close(),d.remove()}})():alert("Please select an image.")},o=({observer:t,shouldDestroyObserver:n=!1})=>{const o=e("Focal Point X"),a=e("Focal Point Y");if(o&&a){const e=document.createElement("button");e.className="btn btn-secondary focal-point-button",e.type="button",e.innerHTML="Add focal point",e.addEventListener("click",r);const o=a.closest(".page-editor__sidebar__fieldset__field, .col-ddm");o&&o.classList.contains("col-ddm")&&e&&(e.style.height="2.5rem",e.style.alignSelf="center",e.style.marginBottom="1.375rem"),o&&!o.querySelector("focal-point-button")&&(o.after(e),t&&n&&t.disconnect())}},a=(e,t)=>{let n=null;return(...r)=>{window.clearTimeout(n),n=window.setTimeout(()=>{e.apply(null,r)},t)}};var l=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","#","$","%","*","+",",","-",".",":",";","=","?","@","[","]","^","_","{","|","}","~"],i=e=>{let t=0;for(let n=0;n<e.length;n++){let r=e[n];t=83*t+l.indexOf(r)}return t},s=(e,t)=>{var n="";for(let r=1;r<=t;r++){let o=Math.floor(e)/Math.pow(83,t-r)%83;n+=l[Math.floor(o)]}return n},c=e=>{let t=e/255;return t<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)},u=e=>{let t=Math.max(0,Math.min(1,e));return t<=.0031308?Math.trunc(12.92*t*255+.5):Math.trunc(255*(1.055*Math.pow(t,.4166666666666667)-.055)+.5)},d=(e,t)=>(e=>e<0?-1:1)(e)*Math.pow(Math.abs(e),t),h=class extends Error{constructor(e){super(e),this.name="ValidationError",this.message=e}},f=e=>{let t=e>>8&255,n=255&e;return[c(e>>16),c(t),c(n)]},b=(e,t)=>{let n=Math.floor(e/361),r=Math.floor(e/19)%19,o=e%19;return[d((n-9)/9,2)*t,d((r-9)/9,2)*t,d((o-9)/9,2)*t]},m=(e,t,n,r)=>{(e=>{if(!e||e.length<6)throw new h("The blurhash string must be at least 6 characters");let t=i(e[0]),n=Math.floor(t/9)+1,r=t%9+1;if(e.length!==4+2*r*n)throw new h(`blurhash length mismatch: length is ${e.length} but it should be ${4+2*r*n}`)})(e),r|=1;let o=i(e[0]),a=Math.floor(o/9)+1,l=o%9+1,s=(i(e[1])+1)/166,c=new Array(l*a);for(let t=0;t<c.length;t++)if(0===t){let n=i(e.substring(2,6));c[t]=f(n)}else{let n=i(e.substring(4+2*t,6+2*t));c[t]=b(n,s*r)}let d=4*t,m=new Uint8ClampedArray(d*n);for(let e=0;e<n;e++)for(let r=0;r<t;r++){let o=0,i=0,s=0;for(let u=0;u<a;u++)for(let a=0;a<l;a++){let d=Math.cos(Math.PI*r*a/t)*Math.cos(Math.PI*e*u/n),h=c[a+u*l];o+=h[0]*d,i+=h[1]*d,s+=h[2]*d}let h=u(o),f=u(i),b=u(s);m[4*r+0+e*d]=h,m[4*r+1+e*d]=f,m[4*r+2+e*d]=b,m[4*r+3+e*d]=255}return m},p=(e,t,n,r)=>{let o=0,a=0,l=0,i=4*t;for(let s=0;s<t;s++){let t=4*s;for(let u=0;u<n;u++){let n=t+u*i,d=r(s,u);o+=d*c(e[n]),a+=d*c(e[n+1]),l+=d*c(e[n+2])}}let s=1/(t*n);return[o*s,a*s,l*s]},g=e=>{const t=e.toString(16);return 1===t.length?"0"+t:t},v=(e,t,n)=>"#"+g(e)+g(t)+g(n);function y(e){return 0===e?0:`${e}%`}function w(e,t=4,n=3){return function(e,t,n){const r=[];for(let o=0,a=0;o<e.length;o+=4,a++){const l=a%t,i=Math.floor(a/t),s=Math.round(l/(t-1)*100),c=Math.round(i/(n-1)*100),u=e[o],d=e[o+1],h=e[o+2],f=`radial-gradient(at ${y(s)} ${y(c)},${v(u,d,h)},#00000000 50%)`;r.push(f)}return r}(m(e,t,n),t,n)}const M=()=>document.querySelector('input[name^="_com_liferay_journal_web_portlet_JournalPortlet_ddm$$Image"]'),_=async e=>{const t=(e=>{const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");return n.drawImage(e,0,0),n.getImageData(0,0,e.width,e.height)})(await(async e=>new Promise((t,n)=>{const r=new Image;r.onload=()=>t(r),r.onerror=(...e)=>n(e),r.src=e}))(e));return((e,t,n,r,o)=>{if(r<1||r>9||o<1||o>9)throw new h("BlurHash must have between 1 and 9 components");if(t*n*4!==e.length)throw new h("Width and height must match the pixels array");let a=[];for(let l=0;l<o;l++)for(let o=0;o<r;o++){let r=0==o&&0==l?1:2,i=p(e,t,n,(e,a)=>r*Math.cos(Math.PI*o*e/t)*Math.cos(Math.PI*l*a/n));a.push(i)}let l,i=a[0],c=a.slice(1),f="";if(f+=s(r-1+9*(o-1),1),c.length>0){let e=Math.max(...c.map(e=>Math.max(...e))),t=Math.floor(Math.max(0,Math.min(82,Math.floor(166*e-.5))));l=(t+1)/166,f+=s(t,1)}else l=1,f+=s(0,1);return f+=s((e=>(u(e[0])<<16)+(u(e[1])<<8)+u(e[2]))(i),4),c.forEach(e=>{f+=s(((e,t)=>19*Math.floor(Math.max(0,Math.min(18,Math.floor(9*d(e[0]/t,.5)+9.5))))*19+19*Math.floor(Math.max(0,Math.min(18,Math.floor(9*d(e[1]/t,.5)+9.5))))+Math.floor(Math.max(0,Math.min(18,Math.floor(9*d(e[2]/t,.5)+9.5)))))(e,l),2)}),f})(t.data,t.width,t.height,4,4)},x=async r=>{const o=(e=>{let t;if("input"===e.tagName.toLowerCase())try{const n=JSON.parse(e.value),{fileEntryId:r=null,url:o=null}=n;r&&o&&(t=(({fileEntryId:e,url:t,width:n})=>`/o/adaptive-media/image/${e}/Thumbnail-${n}x${n}/${t.split("/").slice(-1)[0].split("?")[0]}?t=${Date.now()}`)({fileEntryId:r,url:o,width:300}))}catch(e){console.error(e)}else if("img"===e.tagName.toLowerCase()){const n=e?.parentElement?.firstElementChild;t=n?.srcset}return t})("fragment"===r?t():M()),a=e("BlurHash");if(o&&a){const e=await _(o),{backgroundImage:t}=function(e,t=4,n=3){return{backgroundImage:w(e,t,n).join(",")}}(e);if(a.value!==t){n(a,t);const e=document.querySelector('input[name^="_com_liferay_journal_web_portlet_JournalPortlet_ddm$$Image"][name$="description"]');e?.focus()}}},P=e=>{const n="fragment"===e?t():M();if(e&&n&&!Liferay.blurHashObserver){const t=a(()=>x(e),500);Liferay.blurHashObserver=new MutationObserver(t);const r={attributes:!0,childList:!1,subtree:!1};Liferay.blurHashObserver.observe(n,r)}x(e)},E=()=>{const e=document.querySelector("#_com_liferay_journal_web_portlet_JournalPortlet_fieldsContent");if(e){Liferay.focalPointWebContentObserver&&Liferay.focalPointWebContentObserver.disconnect();const t=a(()=>{P("content"),o({observer:n,shouldDestroyObserver:!0})},500);Liferay.focalPointWebContentObserver=new MutationObserver(t);const n=Liferay.focalPointWebContentObserver,r={attributes:!1,childList:!0,subtree:!0};n.observe(e,r)}},L=()=>{const e=document.querySelector(".page-editor__item-configuration-sidebar");if(e){Liferay.focalPointFragmentObserver&&Liferay.focalPointFragmentObserver.disconnect();const t=a(()=>{P("fragment"),o({observer:n,shouldDestroyObserver:!1})},500);Liferay.focalPointFragmentObserver=new MutationObserver(t);const n=Liferay.focalPointFragmentObserver,r={attributes:!1,childList:!0,subtree:!1};n.observe(e,r)}},O=()=>{Liferay.blurHashObserver?.disconnect(),delete Liferay.blurHashObserver,Liferay.focalPointFragmentObserver?.disconnect(),delete Liferay.focalPointFragmentObserver,Liferay.focalPointWebContentObserver?.disconnect(),delete Liferay.focalPointWebContentObserver};Liferay.on("allPortletsReady",()=>{O(),E(),setTimeout(L,500)}),Liferay.on("endNavigate",()=>{O(),E(),setTimeout(L,500)})})();